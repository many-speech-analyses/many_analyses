---
title: "OSF management"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
library(here)
library(tidyverse)
library(osfr)
library(speakr)
```

# Manage OSF with osfr

This document contains the code used to manage the OSF repo with the [osfr](https://docs.ropensci.org/osfr/) package.

# Retrieve OSF repo and components

```{r retrieve}
# Main repo "Many Speech Analysis": https://osf.io/3bmcp/
osf_repo <- osf_retrieve_node("3bmcp")
# Repo components
osf_comps <- osf_ls_nodes(osf_repo)
# Dataset & Materials component
data_comp <- osf_comps %>% filter(name == "Data")
```

# List data_comp files

```{r data_files}
osf_ls_files(data_comp)
```

# Readme files

We can knit the readme files (they are GitHub documents, i.e. `.Rmd` files that are converted to `.md` files upon knitting).

```{r knit-readmes, message=FALSE, warning=FALSE}
files <- list.files("./osf/data", pattern = "[.]Rmd$", recursive = T, full.names = T)

for (f in files) {
  xfun::Rscript_call(rmarkdown::render, list(f))
}
```


```{r upload-readmes}
# A loop would be better

# data/ ----
osf_upload(data_comp, path = "./osf/data/README.md", conflicts = "overwrite", verbose = T)

data_comp_files <- osf_ls_files(data_comp)



# data/norming/ ----
raw <- data_comp_files %>% filter(name == "norming")

#### delete old readme ("overwrite" option fails)
old_readme <- osf_ls_files(data_comp, "norming", pattern = "README.md")
osf_rm(old_readme, check = FALSE)

#### upload new readme
osf_upload(
  raw,
  path = "./osf/data/norming/README.md",
  conflicts = "overwrite", verbose = T)



# data/norming/images/ ----
#### delete old readme
old_readme <- osf_ls_files(data_comp, "norming/images/", pattern = "README.md")
osf_rm(old_readme, check = FALSE)

#### upload new readme
audio <- osf_ls_files(data_comp, "norming", pattern = "images")
osf_upload(
  audio,
  path = "./osf/data/norming/images/README.md",
  conflicts = "overwrite", verbose = T)



# data/production/audio/ ----
#### delete old readme
# old_readme <- osf_ls_files(data_comp, "production/audio", pattern = "README.md")
# osf_rm(old_readme, check = FALSE)
# 
# #### upload new readme
# audio <- osf_ls_files(data_comp, "production", pattern = "audio")
# osf_upload(
#   audio,
#   path = "./osf/data/production/audio/README.md",
#   conflicts = "overwrite", verbose = T)



# data/production/trial-lists ----
#### delete old readme
# old_readme <- osf_ls_files(data_comp, "production/trial-lists", pattern = "README.md")
# osf_rm(old_readme, check = FALSE)
# 
# #### upload new readme
# trials <- osf_ls_files(data_comp, "production", pattern = "trial-lists")
# osf_upload(
#   trials,
#   path = "./osf/data/production/trial-lists/README.md",
#   conflicts = "overwrite", verbose = T)
```

# PDF of norming and production methods

```{r pdf-methods}
file.copy("./docs/methods_norm_prod/methods_norm_prod.pdf", "./osf/data/", overwrite = T)

osf_upload(data_comp, path = "./osf/data/methods_norm_prod.pdf", conflicts = "overwrite", verbose = T)
```

# Norming study

```{r ratings}
ratings <- read_csv("./data/dataset/ratings.csv") %>%
  mutate(
    # Fix wrong encoding
    object = str_replace(object, "W�_scheklammer", "Waescheklammer"),
    object = str_replace(object, "M̦hre", "Moehre"),
    # Humanise subject ids
    subject_id = as.numeric(as.factor(`prolific id`))
  ) %>%
  select(subject_id, object, colour, typicality) %>%
  arrange(subject_id, object, colour) %>%
  mutate(
    object_en = case_when(
      object == "Ananas" ~ "pineapple",
      object == "Aprikose" ~ "apricot",
      object == "Aubergine" ~ "aubergine",
      object == "Avocado" ~ "avocado",
      object == "Banane" ~ "banana",
      object == "Birne" ~ "pear",
      object == "Bohnen" ~ "beans",
      object == "Bueroklammer" ~ "paper.clip",
      object == "Erbsen" ~ "peas",
      object == "Erdbeere" ~ "strawberry",
      object == "Gurke" ~ "cucumber",
      object == "Kartoffeln" ~ "potatoes",
      object == "Kirsche" ~ "cherry",
      object == "Mandarine" ~ "mandarine",
      object == "Moehre" ~ "carrots",
      object == "Paprika" ~ "pepper",
      object == "Socken" ~ "socks",
      object == "Sonnenbrille" ~ "suglasses",
      object == "Tomate" ~ "tomato",
      object == "Trauben" ~ "grapes",
      object == "Waescheklammer" ~ "clothes.peg",
      object == "Walnuss" ~ "walnut",
      object == "Zitrone" ~ "lemon",
      object == "Zucchini" ~ "courgettes"
    ),
    colour_en = case_when(
      colour == "blau" ~ "blue",
      colour == "braun" ~ "brown",
      colour == "gelb" ~ "yellow",
      colour == "grau" ~ "gray",
      colour == "gruen" ~ "green",
      colour == "lila" ~ "lilac",
      colour == "orange" ~ "orange",
      colour == "rot" ~ "red",
      colour == "schwarz" ~ "black"
    )
  )

write_csv(ratings, "./osf/data/norming/ratings/ratings.csv")

ratings_summary <- ratings %>%
  group_by(object, colour, object_en, colour_en) %>%
  summarise(
    typ_mean = mean(typicality),
    typ_sd = sd(typicality),
    typ_median = median(typicality),
    .groups = "drop"
  )

write_csv(ratings_summary, "./osf/data/norming/ratings/ratings_summary.csv")
```

```{r ratings-upload}
rats <- osf_ls_files(data_comp, "norming", pattern = "ratings")

# delete old tgs
osf_rm(rats, check = FALSE)
osf_mkdir(data_comp, "norming/ratings")

# upload new tgs
new_ratings <- list.files("./osf/data/norming/ratings", ".csv", full.names = TRUE)

rats <- osf_ls_files(data_comp, "norming", pattern = "ratings")
osf_upload(rats, new_ratings, conflicts = "overwrite", verbose = T, progress = T)
```


# Production study

## TextGrids

```{r textgrids}
praat_run("./scripts/praat/prep_textgrids.praat")
```

```{r textgrids-upload}
audio <- osf_ls_files(data_comp, "production", pattern = "audio")

# delete old tgs
osf_rm(audio, check = FALSE)
osf_mkdir(data_comp, "production/audio")

# upload new tgs
new_tgs <- list.files("./osf/data/production/audio", ".TextGrid", full.names = TRUE)

audio <- osf_ls_files(data_comp, "production", pattern = "audio")
osf_upload(audio, new_tgs, conflicts = "overwrite", verbose = T, progress = T)
```

## Trial lists

```{r tlists}
tlists <- list.files("./data/trial-lists", ".csv", full.names = TRUE)
typ <- read_csv("./data/dataset/typicality.csv")

for (tlist in tlists) {
  speaker <- str_sub(tlist, 20, 21)
  tbl <- read_csv(tlist) %>%
    mutate(
      speaker = speaker,
      trial = row_number()
    ) %>%
    left_join(y = typ) %>%
    select(speaker, trial, condition, typicality, everything()) %>%
    mutate(typicality = ifelse(condition == "NF", typicality, NA)) %>%
    left_join(y = ratings_summary, by = c("target_name" = "object", "target_colour" = "colour"))
  
  write_csv(tbl, file = paste0("./osf/data/production/trial-lists/", speaker, ".csv"))
}
```

```{r tlists-upload}
trials <- osf_ls_files(data_comp, "production", pattern = "trial-lists")

# delete old trials
old_trials <- osf_ls_files(trials, pattern = ".csv", n_max = Inf)

for (file in 1:nrow(old_trials)) {
  osf_rm(old_trials[file,], check = FALSE)
}

# upload new trials
new_trials <- list.files("./osf/data/production/trial-lists/", ".csv", full.names = TRUE)

for (trial in new_trials) {
  osf_upload(
    trials,
    path = trial,
    conflicts = "overwrite", verbose = T
  )
}
```

