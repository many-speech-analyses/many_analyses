---
title: "OSF management"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
library(tidyverse)
library(osfr)
```

# Manage OSF with osfr

This document contains the code used to manage the OSF repo with the [osfr](https://docs.ropensci.org/osfr/) package.

# Retrieve OSF repo and components

```{r retrieve}
# Main repo "Many Speech Analysis": https://osf.io/3bmcp/
osf_repo <- osf_retrieve_node("3bmcp")
# Repo components
osf_comps <- osf_ls_nodes(osf_repo)
# Dataset & Materials component
data_comp <- osf_comps %>% filter(name == "Data")
```

# List data_comp files

```{r data_files}
osf_ls_files(data_comp)
```

# Knit readme files

We can knit the readme files (they are GitHub documents, i.e. `.Rmd` files that are converted to `.md` files upon knitting).

```{r knit-all, message=FALSE, warning=FALSE}
files <- list.files("./osf/comps/data", pattern = "[.]Rmd$", recursive = T, full.names = T)

for (f in files) {
  xfun::Rscript_call(rmarkdown::render, list(f))
}
```


# Upload files to the OFS repo

```{r readmes}
# A loop would be better
osf_upload(data_comp, path = "./osf/comps/data/README.md", conflicts = "overwrite", verbose = T)

data_comp_files <- osf_ls_files(data_comp)

# data/norming/
raw <- data_comp_files %>% filter(name == "norming")

#### delete old readme ("overwrite" option fails)
old_readme <- osf_ls_files(data_comp, "norming", pattern = "README.md")
osf_rm(old_readme, check = FALSE)

#### upload new readme
osf_upload(
  raw,
  path = "./osf/comps/data/norming/README.md",
  conflicts = "overwrite", verbose = T)

# data/production/audio/
#### delete old readme
old_readme <- osf_ls_files(data_comp, "production/audio", pattern = "README.md")
osf_rm(old_readme, check = FALSE)

#### upload new readme
audio <- osf_ls_files(data_comp, "production", pattern = "audio")
osf_upload(
  audio,
  path = "./osf/comps/data/production/audio/README.md",
  conflicts = "overwrite", verbose = T)

# data/production/trial-lists
#### delete old readme
old_readme <- osf_ls_files(data_comp, "production/trial-lists", pattern = "README.md")
osf_rm(old_readme, check = FALSE)

#### upload new readme
trials <- osf_ls_files(data_comp, "production", pattern = "trial-lists")
osf_upload(
  trials,
  path = "./osf/comps/data/production/trial-lists/README.md",
  conflicts = "overwrite", verbose = T)
```

