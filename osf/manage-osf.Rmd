---
title: "OSF management"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
library(tidyverse)
library(osfr)
```

# Manage OSF with osfr

This document contains the code used to manage the OSF repo with the [osfr](https://docs.ropensci.org/osfr/) package.

# Retrieve OSF repo and components

```{r retrieve}
# Main repo "Many Speech Analysis": https://osf.io/3bmcp/
osf_repo <- osf_retrieve_node("3bmcp")
# Repo components
osf_comps <- osf_ls_nodes(osf_repo)
# Dataset & Materials component
data_comp <- osf_comps %>% filter(name == "Data")
```

# List data_comp files

```{r data_files}
osf_ls_files(data_comp)
```

# Knit readme files

We can knit the readme files (they are GitHub documents, i.e. `.Rmd` files that are converted to `.md` files upon knitting).

```{r knit-all, message=FALSE, warning=FALSE}
files <- list.files("./osf/comps/data", pattern = "[.]Rmd$", recursive = T, full.names = T)

for (f in files) {
  xfun::Rscript_call(rmarkdown::render, list(f))
}
```


# Upload files to the OFS repo

```{r readmes}
# A loop would be better
osf_upload(data_comp, path = "./osf/comps/data/README.md", conflicts = "overwrite", verbose = T)

data_comp_files <- osf_ls_files(data_comp)

# data/data
raw <- data_comp_files %>% filter(name == "data")

osf_rm(osf_ls_files(data_comp, "data", pattern = "README.md"), check = FALSE)
osf_upload(raw, path = "./osf/comps/data/data/README.md", conflicts = "overwrite", verbose = T)

# data/exp-materials
materials <- data_comp_files %>% filter(name == "exp-materials")

osf_rm(osf_ls_files(data_comp, "exp-materials", pattern = "README.md"), check = FALSE)
osf_upload(materials, path = "./osf/comps/data/exp-materials/README.md", conflicts = "overwrite", verbose = T)

# data/exp-materials/norming
osf_rm(osf_ls_files(data_comp, "exp-materials/norming", pattern = "README.md"), check = FALSE)
osf_upload(osf_ls_files(data_comp, "exp-materials", pattern = "norming"), path = "./osf/comps/data/exp-materials/norming/README.md", conflicts = "overwrite", verbose = T)

# data/exp-materials/experiment
osf_rm(osf_ls_files(data_comp, "exp-materials/experiment", pattern = "README.md"), check = FALSE)
osf_upload(osf_ls_files(data_comp, "exp-materials", pattern = "experiment"), path = "./osf/comps/data/exp-materials/experiment/README.md", conflicts = "overwrite", verbose = T)
```

