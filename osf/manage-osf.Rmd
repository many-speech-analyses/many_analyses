---
title: "OSF management"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
library(tidyverse)
library(osfr)
```

# Manage OSF with osfr

This document contains the code used to manage the OSF repo with the [osfr](https://docs.ropensci.org/osfr/) package.

# Retrieve OSF repo and components

```{r retrieve}
# Main repo "Many Speech Analysis": https://osf.io/3bmcp/
osf_repo <- osf_retrieve_node("3bmcp")
# Repo components
osf_comps <- osf_ls_nodes(osf_repo)
# Dataset & Materials component
data_comp <- osf_comps %>% filter(name == "Dataset & Materials")
```

# List data_comp files

```{r data_files}
osf_ls_files(data_comp)
```

# Knit readme files

We can knit the readme files (they are GitHub documents, i.e. `.Rmd` files that are converted to `.md` files upon knitting).

```{r knit-all, message=FALSE, warning=FALSE}
files <- list.files("./osf/comps", pattern = "[.]Rmd$", recursive = T, full.names = T)

for (f in files) {
  xfun::Rscript_call(rmarkdown::render, list(f))
}
```


# Upload files to the OFS repo

```{r readmes}
# A loop would be better
osf_upload(data_comp, path = "./osf/comps/dataset/README.md", conflicts = "overwrite", verbose = T)

data_comp_files <- osf_ls_files(data_comp)

materials <- data_comp_files %>% filter(name == "Materials")
osf_upload(materials, path = "./osf/comps/dataset/materials/README.md", conflicts = "overwrite", verbose = T)

raw <- data_comp_files %>% filter(name == "Raw data")
osf_upload(raw, path = "./osf/comps/dataset/raw/README.md", conflicts = "overwrite", verbose = T)

tgs <- data_comp_files %>% filter(name == "TextGrids")
osf_upload(tgs, path = "./osf/comps/dataset/textgrids/README.md", conflicts = "overwrite", verbose = T)

osf_rm(osf_ls_files(data_comp, "Materials/Norming results", pattern = "README.md"), check = FALSE)
osf_upload(osf_ls_files(data_comp, "Materials", type = "folder", pattern = "Norm"), path = "./osf/comps/dataset/materials/norming-results/README.md", conflicts = "overwrite", verbose = T)

osf_rm(osf_ls_files(data_comp, "Materials/Trial lists", pattern = "README.md"), check = FALSE)
osf_upload(osf_ls_files(data_comp, "Materials", type = "folder", pattern = "Trial lists"), path = "./osf/comps/dataset/materials/trials/README.md", conflicts = "overwrite", verbose = T)
```

