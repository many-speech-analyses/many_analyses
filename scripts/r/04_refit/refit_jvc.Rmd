---
title: "Re-fit"
subtitle: "JVC"
output: 
  html_document:
    toc: true
date: "Last update: `r Sys.Date()`"
editor_options: 
  chunk_output_type: console
---

# Setup

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(
  echo = TRUE, 
  message = FALSE, 
  warning = FALSE
  )

knitr::opts_knit$set(root.dir = here::here())
```

```{r}
#| label: libs
library("here")
library("fs")
library("dplyr")
library("tidyr")
library("readr")
library("readxl")
library("forcats")
library("ggplot2")
library("stringr")
library("strex")
library("purrr")
library("lme4")
library("brms")
library("broom")
library("broom.mixed")
```

```{r}
#| label: helpers
#| include: false
# Plotting theme because Im extra
clean_theme <- function(...) {
  list(
    theme_minimal(), 
    theme(
      axis.title.y = element_text(size = rel(.9), hjust = 0.95),
      axis.title.x = element_text(size = rel(.9), hjust = 0.95),
      panel.grid.major = element_line(colour = 'grey90', size = 0.15),
      panel.grid.minor = element_line(colour = 'grey90', size = 0.15))
  )
}

# Functional sequence to get relevant info from Rds files
clean_up <- . %>% 
  tidy(effects = "fixed") %>% 
  suppressWarnings() %>% 
  filter(term %in% c("effect_cattypical", "effect_con")) %>% 
  dplyr::select(term, estimate, se = std.error)

# Function for printing unordered lists
print_status <- function(name) {
  filter(teams, team == name) %>% 
  pivot_longer(cols = -team, names_to = "var", values_to = "val") %>% 
  mutate(out = glue::glue("- {var}: {val}\n")) %>% 
  pull(out) 
}
```


# Refits

**Teams**: 

```{r}
#| label: teams
#| echo: false
teams <- tribble(
  ~'team',                  ~"Reviewed", ~'Included', 
  "anomalocaris_ornata",      TRUE,           TRUE,
  "anthracoceros_coronata",   TRUE,           TRUE,
  "arapaima_modularis",       TRUE,           TRUE,
  "comanthina_maculatus",     TRUE,           TRUE,
  "cromileptes_saxatilis",    TRUE,           TRUE,
  "ctenosaura_limax",         TRUE,           FALSE,
  "gnathosaurus_canadensis",  TRUE,           TRUE,
  "gymnothorax_spinulosus",   TRUE,           TRUE,
  "haematopus_fossor",        TRUE,           TRUE,
  "lasionycteris_altavela",   TRUE,           TRUE,
  "linckia_nattereri",        TRUE,           FALSE,
  "lycodes_bradfieldi",       TRUE,           FALSE,
  "naso_cassivellaunos",      TRUE,           TRUE,
  "trapezia_cantonensis",     TRUE,           TRUE,
  "trigonias_lachneri",       TRUE,           TRUE,
  "psittacula_scabriculus",   TRUE,           TRUE, 
  "clione_dorsalis",          TRUE,           TRUE
  )

knitr::kable(teams)
```

**Current status**: 

```{r}
#| label: status
#| echo: false
teams %>% 
  summarize(Reviewed = mean(Reviewed), Included = mean(Included)) %>% 
  pivot_longer(cols = everything(), names_to = " ", values_to = "%") %>% 
  mutate(`%` = round(`%` * 100, 2)) %>% 
  knitr::kable(format = "pipe")
```

## anomalocaris_ornata

```{r}
#| label: print_anomalocaris_ornata
#| echo: false
#| results: 'asis'
print_status("anomalocaris_ornata")
```

```{r}
#| label: anomalocaris_ornata

unzip(here("data", "analyses", "jvc", "anomalocaris_ornata", "MSA.zip"), exdir = here("data", "analyses", "jvc", "anomalocaris_ornata"))

# Analyst team setup
main.df <- read.csv2(here("data", "analyses", "jvc", 
  "anomalocaris_ornata", "MSA", "data", "data_frame.csv")
  )

df.int <- main.df %>%
  filter(keep == "yes") %>%  
  filter(condition == "NF") %>% 
  mutate(typicality = fct_relevel(typicality, "typical", "medium", "atypical"))

df.int$Mean_dB <- as.numeric(df.int$Mean_dB)

# F0
df.f0 <- main.df
df.f0 <- df.f0 %>%
  #filter(stress == "stressed") %>%
  filter(keep == "yes") %>% 
  filter(condition == "NF") %>%
  #filter(phoneme %in% c("AO","AW","IH","o","OEH","UH","AH","EH","EH?","u","a?","i","i?" )) %>% 
  gather(f0_point, f0, F0AtPoint1, F0AtPoint2, F0AtPoint3, F0AtPoint4,
         F0AtPoint5,F0AtPoint6,F0AtPoint7,F0AtPoint8,F0AtPoint9,F0AtPoint10)%>% 
  filter(f0 !="--undefined--")%>% 
  mutate(typicality = fct_relevel(typicality, "typical", "medium", "atypical")) %>% 
  group_by(voice_type, col_obj)

df.f0$f0 <- as.numeric(df.f0$f0)
outliers <- boxplot(df.f0$f0, plot=F)$out
f0.clean <- df.f0[-which(df.f0$f0 %in% outliers),]
f0.clean <- f0.clean %>% 
  ungroup() %>% 
  group_by(speaker) %>% 
  mutate(f0min = min(f0)) %>%
  mutate(f0sem=(12*log(f0 /f0min))/log(2)) %>% 
  ungroup()

under <- f0.clean %>% 
  filter(f0<150)
over <- f0.clean %>% 
  filter(f0>150)

# Vowel
vowel.df <- main.df
vowel.df$Duration_in_ms <- as.numeric(vowel.df$Duration_in_ms)
vowel.df <- vowel.df %>%
  filter(keep == "yes") %>%  
  filter(condition == "NF") %>% 
  filter(stress =="stressed") %>% 
  mutate(typicality = fct_relevel(typicality, "typical", "medium","atypical")) %>%
  filter(Duration_in_ms>40)

# FREQ MODELS
mod1 <- lmer(Mean_dB^2~typicality*col_obj+voice_type+(1+col_obj|speaker),df.int)
mod2 <- lmer(f0sem~col_obj*typicality+voice_type+(1+col_obj|speaker),under)
mod3 <- lmer(f0sem~col_obj*typicality+voice_type+(1+col_obj|speaker),over)
mod4 <- lmer(Duration_in_ms~typicality*col_obj+(1|Word)+(1|speaker),data = vowel.df)


#
# JVC: Setup and reanalyses
#

# Intensity
MSA_int_df <- df.int %>% 
  mutate(mean_db_2 = Mean_dB ^ 2, 
    db_z = (mean_db_2 - mean(mean_db_2)) / sd(mean_db_2), 
    effect_cat = C(typicality, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"), 
    col_obj = as.factor(col_obj), 
    col_obj = C(col_obj, sum), 
    voice_type = as.factor(voice_type), 
    voice_type = C(voice_type, sum)
)

# Intensity model
anomalocaris_ornata_1_int_cat <- brm(
  db_z ~ effect_cat * col_obj + voice_type + 
    (1 + col_obj | speaker), 
  data = MSA_int_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "anomalocaris_ornata_1_int_cat")
  )

# Pitch "under"
MSA_under_df <- under %>% 
  mutate(f0sem_z = (f0sem - mean(f0sem)) / sd(f0sem), 
    effect_cat = C(typicality, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"), 
    col_obj = as.factor(col_obj), 
    col_obj = C(col_obj, sum), 
    voice_type = as.factor(voice_type), 
    voice_type = C(voice_type, sum)
  )

# Pitch "under" model
anomalocaris_ornata_2_f0under_cat <- brm(
  f0sem_z ~ effect_cat * col_obj + voice_type + 
    (1 + col_obj | speaker), 
  data = MSA_under_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "anomalocaris_ornata_2_f0under_cat")
  )

# Pitch "over"
MSA_over_df <- over %>% 
  mutate(f0sem_z = (f0sem - mean(f0sem)) / sd(f0sem), 
    effect_cat = C(typicality, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"), 
    col_obj = as.factor(col_obj), 
    col_obj = C(col_obj, sum), 
    voice_type = as.factor(voice_type), 
    voice_type = C(voice_type, sum)
  )

# Pitch "over" model
anomalocaris_ornata_3_f0over_cat <- brm(
  f0sem_z ~ effect_cat * col_obj + voice_type + 
    (1 + col_obj | speaker), 
  data = MSA_over_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  control = list(max_treedepth = 15), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "anomalocaris_ornata_3_f0over_cat")
  )

# Duration
MSA_durvowel_df <- vowel.df %>% 
  mutate(dur_z = (Duration_in_ms - mean(Duration_in_ms)) / sd(Duration_in_ms), 
    effect_cat = C(typicality, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"), 
    col_obj = as.factor(col_obj), 
    col_obj = C(col_obj, sum)
  )

anomalocaris_ornata_4_durvowel_cat <- brm(
  dur_z ~ effect_cat * col_obj + 
    (1 | Word) + (1 | speaker), 
  data = MSA_durvowel_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "anomalocaris_ornata_4_durvowel_cat")
  )

```

## anthracoceros_coronata

```{r}
#| label: print_anthracoceros_coronata
#| echo: false
#| results: 'asis'
print_status("anthracoceros_coronata")
```

```{r}
#| label: anthracoceros_coronata

data_long <- read_csv(here("data", "analyses", "jvc", "anthracoceros_coronata", 
  "data", "data_long.csv"))

# Fit LME models (dont converge and not used)
overall_models <- data_long %>% 
  group_by(variable) %>% 
  nest() %>% 
  mutate(model = map(data, ~ lmer(value ~ typ_mean + (1|speaker), data = .)),
         tidy = map(model, broom.mixed::tidy, effects = c("fixed", "ran_vals"), conf.int = TRUE, conf.level =.95)) %>% 
  unnest(tidy) %>% 
  select(-model) 

# Standard lm
overall_models_lm <- data_long %>% 
  group_by(variable) %>% 
  nest() %>% 
  mutate(model = map(data, ~ lm(value ~ typ_mean, data = .)),
         tidy = map(model, tidy, conf.int = TRUE, conf.level =.95)) %>% 
  unnest(tidy) %>% 
  select(-data, -model) 

#
# JVC: setup and refit
#
MSA_ac_all_df <- data_long %>% 
  group_by(variable) %>% 
  mutate(value_z = (value - mean(value, na.rm = T)) / sd(value, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(effect_con = (typ_mean - mean(typ_mean)) / sd(typ_mean))

# A_max_pitch
anthracoceros_coronata_1_pitchadj_con <- brm(
  value_z ~ effect_con, 
  data = filter(MSA_ac_all_df, variable == "A_max_pitch"), 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", 
    "anthracoceros_coronata_1_pitchadj_con")
  )

# N_max_pitch
anthracoceros_coronata_2_pitchnoun_con <- brm(
  value_z ~ effect_con, 
  data = filter(MSA_ac_all_df, variable == "N_max_pitch"), 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", 
    "anthracoceros_coronata_2_pitchnoun_con")
  )

# A_max_intens
anthracoceros_coronata_3_intadj_con <- brm(
  value_z ~ effect_con, 
  data = filter(MSA_ac_all_df, variable == "A_max_intens"), 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", 
    "anthracoceros_coronata_3_intadj_con")
  )

# N_max_intens
anthracoceros_coronata_4_intnoun_con <- brm(
  value_z ~ effect_con, 
  data = filter(MSA_ac_all_df, variable == "N_max_intens"), 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", 
    "anthracoceros_coronata_4_intnoun_con")
  )

# A_dur_log
anthracoceros_coronata_5_duradj_con <- brm(
  value_z ~ effect_con, 
  data = filter(MSA_ac_all_df, variable == "A_dur_log"), 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", 
    "anthracoceros_coronata_5_duradj_con")
  )

# N_dur_log
anthracoceros_coronata_6_durnoun_con <- brm(
  value_z ~ effect_con, 
  data = filter(MSA_ac_all_df, variable == "N_dur_log"), 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", 
    "anthracoceros_coronata_6_durnoun_con")
  )
```

## arapaima_modularis

```{r}
#| label: print_arapaima_modularis
#| echo: false
#| results: 'asis'
print_status("arapaima_modularis")
```

```{r}
#| label: arapaima_modularis

data_manyspeech <- read.csv(here("data", "analyses", "jvc", 
  "arapaima_modularis", "sheet_data_pitch.csv"))

#convert factors and numeric
data_manyspeech$typicality <- factor(data_manyspeech$typicality)
data_manyspeech$target_colour <- factor(data_manyspeech$target_colour)
data_manyspeech$pitch_max_hz <- as.numeric(data_manyspeech$pitch_max_hz)
data_manyspeech$exclude <- factor(data_manyspeech$exclude)

#select variables to be used, exclude error items
clean_data <- data_manyspeech %>%
  select(condition, speaker, typicality, target_colour, pitch_max_hz, exclude) %>%
  filter(condition == "NF",
    exclude == "No") 

#Main stats
summary_clean_data <- clean_data %>%
  group_by(speaker, typicality) %>%
  rstatix::get_summary_stats(pitch_max_hz)

#rename outcome variable 
names(summary_clean_data)[names(summary_clean_data) == 'mean'] <- 'mean_pitch'

#exclude three speakers who had typycality conditions < 6
clean_data_2 <- clean_data %>%
  filter(speaker != "EM",
         speaker != "IP",
         speaker != "JW_3")

#New main stats without 3 excluded participants
data_for_analysis <- clean_data_2 %>%
  group_by(speaker, typicality) %>%
  rstatix::get_summary_stats(pitch_max_hz)

names(data_for_analysis)[names(data_for_analysis) == 'mean'] <- 'mean_pitch'

#find ouliers
outliers <- data_for_analysis %>%
  group_by(typicality) %>%
  rstatix::identify_outliers(mean_pitch)
  #13 outlier data points were found

#continue without outliers
data_for_analysis_noOL <- data_for_analysis %>%
  filter(speaker != "AL",
         speaker != "JR",
         speaker != "PS",
         speaker != "TB")

# Original model
mod1_am <- ez::ezANOVA(data = data_for_analysis_noOL,
        wid = speaker,
        within = typicality,
        dv = mean_pitch,
        type = 3)

#
# JVC: setup df
#
MSA_arapaima_modularis_df <- data_for_analysis_noOL %>% 
  mutate(pitch_z = (mean_pitch - mean(mean_pitch)) / sd(mean_pitch), 
    effect_cat = C(typicality, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"))

# Model
arapaima_modularis_1_f0_cat <- brm(
  pitch_z ~ effect_cat, 
  data = MSA_arapaima_modularis_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "arapaima_modularis_1_f0_cat")
  )
```

## comanthina_maculatus

```{r}
#| label: print_comanthina_maculatus
#| echo: false
#| results: 'asis'
print_status("comanthina_maculatus")
```

```{r}
#| label: comanthina_maculatus

# No code provided
MSA_comanthina_maculatus_df <- read_xlsx(here("data", "analyses", "jvc", 
  "comanthina_maculatus", "0 Clean Data.xlsx"), na = "--undefined--") %>% 
  select(key:typicality, 
    tonic_vowel_duration, tonic_vowel_intensity, tonic_vowel_F0) %>% 
  na.omit() %>% 
  filter(typicality != "medium") %>% 
  mutate(across(starts_with("tonic"), .fns = scale, .names = "{.col}_z")) %>% 
  mutate(effect_cat = as.factor(typicality), 
    effect_cat = C(effect_cat, treatment))

# Model
comanthina_maculatus_1_dur_cat <- brm(
  tonic_vowel_duration_z ~ effect_cat, 
  data = MSA_comanthina_maculatus_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "comanthina_maculatus_1_dur_cat")
  )

comanthina_maculatus_2_int_cat <- brm(
  tonic_vowel_intensity_z ~ effect_cat, 
  data = MSA_comanthina_maculatus_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "comanthina_maculatus_2_int_cat")
  )

comanthina_maculatus_3_f0_cat <- brm(
  tonic_vowel_F0_z ~ effect_cat, 
  data = MSA_comanthina_maculatus_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "comanthina_maculatus_3_f0_cat")
  )
```

## cromileptes_saxatilis

```{r}
#| label: print_cromileptes_saxatilis
#| echo: false
#| results: 'asis'
print_status("cromileptes_saxatilis")
```

```{r}
#| label: cromileptes_saxatilis

cromileptes_saxatilis_durs <- read_csv(here("data", "analyses", "jvc", "cromileptes_saxatilis", "processed_data", "NF_durations.csv")) %>% 
  filter(typicality != "medium")

mod_priors <- c(
  prior("normal(-1, 1)", class="Intercept"),
  prior("normal(0, 2)", class="b"),
  prior("student_t(3, 0, 1)", class="sd"),
  prior("lkj(2)", class="L")
)

# Original model
if(F) {
set.seed(12341234)
mod <- brm(colour_dur ~ 
             typicality + 
             (1 + typicality | target_colour) + 
             (1 | target_name) + 
             (1 | speaker),
           data=cromileptes_saxatilis_durs, cores=4,
           family=lognormal(),
           prior=mod_priors,
           control=list(adapt_delta=0.99,
                        max_treedepth=16),
           iter=4000,
           warmup=2000)
}

#
# JVC refits
#

MSA_cromileptes_saxatilis_df <- cromileptes_saxatilis_durs %>% 
  mutate(colour_dur_log = log(colour_dur), 
    colour_dur_z = (colour_dur_log - mean(colour_dur_log)) / sd(colour_dur_log), 
    effect_cat = as.factor(typicality), 
    effect_cat = C(effect_cat, treatment))

cromileptes_saxatilis_1_dur_cat <- brm(
  colour_dur_z ~ effect_cat + 
    (1 + typicality | target_colour) + 
    (1 | target_name) + 
    (1 | speaker), 
  data = MSA_cromileptes_saxatilis_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "cromileptes_saxatilis_1_dur_cat")
  )
```

## ctenosaura_limax

```{r}
#| label: print_ctenosaura_limax
#| echo: false
#| results: 'asis'
print_status("ctenosaura_limax")
```

```{r}
#| label: ctenosaura_limax

```

## gnathosaurus_canadensis

```{r}
#| label: print_gnathosaurus_canadensis
#| echo: false
#| results: 'asis'
print_status("gnathosaurus_canadensis")
```

```{r}
#| label: gnathosaurus_canadensis

# Load teams data
gnathosaurus_canadensis_typ <- read_xlsx(here("data", "analyses", "jvc", 
  "gnathosaurus_canadensis", "typ.xlsx"))

# Refit original model
f_test <- friedman.test(
  y = gnathosaurus_canadensis_typ$median_st_diff, 
  groups = gnathosaurus_canadensis_typ$typicality, 
  blocks = gnathosaurus_canadensis_typ$speaker
  ) 

#
# JVC refits
#

MSA_gnathosaurus_canadensis_df <- gnathosaurus_canadensis_typ %>% 
  mutate(median_diff_z = (median_st_diff - mean(median_st_diff)) / sd(median_st_diff),
    effect_cat = as.factor(typicality), 
    effect_cat = C(effect_cat, treatment))

gnathosaurus_canadensis_1_f0diff_cat <- brm(
  median_diff_z ~ effect_cat, 
  data = MSA_gnathosaurus_canadensis_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "gnathosaurus_canadensis_1_f0diff_cat")
  )

```

## gymnothorax_spinulosus

```{r}
#| label: print_gymnothorax_spinulosus
#| echo: false
#| results: 'asis'
print_status("gymnothorax_spinulosus")
```

```{r}
#| label: gymnothorax_spinulosus

gymnothorax_spinulosus_data <- read.csv2(here("data", "analyses", "jvc", "gymnothorax_spinulosus", "Many_speech_final_3.csv"), dec = ".") %>% 
  mutate(measure = vowel_intensity_diff, 
    speaker = as.factor(speaker), 
    trial = as.factor(trial), 
    condition = as.factor(condition), 
    token = as.factor(token), 
    target_colour = as.factor(target_colour))

# Exclusion process
sd_intensity <- sd(gymnothorax_spinulosus_data$vowel_intensity_diff)
min_int_diff <- median(gymnothorax_spinulosus_data$vowel_intensity_diff)-1.5*sd_intensity
max_int_diff <- median(gymnothorax_spinulosus_data$vowel_intensity_diff)+1.5*sd_intensity
gymnothorax_spinulosus_data$exclude <- 0
gymnothorax_spinulosus_data[which(gymnothorax_spinulosus_data$vowel_intensity_diff<min_int_diff),]$exclude <- 1
gymnothorax_spinulosus_data$exclude <- factor(gymnothorax_spinulosus_data$exclude)
gymnothorax_spinulosus_int <- gymnothorax_spinulosus_data[which(gymnothorax_spinulosus_data$exclude==0),]
gymnothorax_spinulosus_int$typ_mean <- gymnothorax_spinulosus_int$typ_mean/100

#
# Fit original model
#
fit0 <- lmer(measure ~ condition * typ_mean + 
    (1|target_colour) + 
    (1|speaker),
  data = gymnothorax_spinulosus_int, 
  REML = FALSE , 
  na.action = na.exclude
  )

# Set up post hoc comparisons
contmat <- rbind(c(0,0,0,1,0,0), c(0,0,0,1,1,0), c(0,0,0,1,0,1))
rownames(contmat) <- c('pente AF','pente ANF','pente NF')
comp_mult <- summary(multcomp::glht(fit0, linfct = contmat))
comp_mult

#
# JVC refits
#
MSA_gymnothorax_spinulosus_df <- gymnothorax_spinulosus_int %>% 
  mutate(measure_z = (measure - mean(measure)) / sd(measure),
    effect_con = (typ_mean - mean(typ_mean)) / sd(typ_mean), 
    condition_s = as.factor(condition),
    condition_s = C(condition_s, sum))
#  filter(condition == "AF")

gymnothorax_spinulosus_1_intdiff_con <- brm(
  measure_z ~ effect_con * condition_s + 
    (1|target_colour) + 
    (1|speaker), 
  data = MSA_gymnothorax_spinulosus_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  control = list(max_treedepth = 14), 
  file = here("data", "analyses", "models", "gymnothorax_spinulosus_1_intdiff_con")
  )

```

## haematopus_fossor

```{r}
#| label: print_haematopus_fossor
#| echo: false
#| results: 'asis'
print_status("haematopus_fossor")
```

```{r}
#| label: haematopus_fossor

directory <- here("data", "osf", "production", "trial-lists")
list_of_files = dir(here("data", "osf", "production", "trial-lists"))

trial_data = data.frame()
for(file in list_of_files) {
  this_file = read.csv(paste0(directory, "/", file), stringsAsFactors = FALSE)
  trial_data = rbind(trial_data, this_file)
}

trial_data$typicality = factor(trial_data$typicality)
contrasts(trial_data$typicality) = contr.helmert(3)
dimnames(contrasts(trial_data$typicality))[[2]] = c("atypical", "typical")

#
# DURATION
#

# Get duration data
duration <- read_csv(here("data", "analyses", "jvc", "haematopus_fossor", 
  "details", "analysis", "wordDurations.csv")) %>% 
  filter(adj != "")

# Merge in trial data
duration$speaker = gsub(".TextGrid", "", duration$participant)
duration_full = merge(duration, trial_data)

# Remove errors
duration_full = filter(duration_full, comments!="hesitation break")

# Centre relevant variables
duration_full$adjdur.c = scale(duration_full$adjdur, scale=FALSE)
duration_full$noundur.c = scale(duration_full$noundur, scale=FALSE)
duration_full$framedur.c = scale(duration_full$framedur, scale=FALSE)

# LME models
# Adjective duration
adj_duration_model = lmer(adjdur.c ~ trial * typicality + (1 | adj) + (1 | speaker), duration_full)

# Noun duration
noun_duration_model = lmer(noundur.c ~ trial * typicality + (1 | noun) + (1 | speaker), duration_full)

# Frame duration
frame_duration_model = lmer(framedur.c ~ trial * typicality + (1 | speaker), duration_full)

#
# JVC: setup df
#
MSA_duration_df <- duration_full %>% 
  mutate(across(c("adjdur", "noundur", "framedur"), .fns = scale, 
    .names = "{.col}_z")) %>% 
  mutate(effect_cat = C(typicality, treatment))


# Adjective duration
haematopus_fossor_1_adjdur_cat <- brm(
  adjdur_z ~ trial * effect_cat + 
    (1 | adj) + (1 | speaker), 
  data = MSA_duration_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "haematopus_fossor_1_adjdur_cat")
  )

# Noun duration
haematopus_fossor_2_noundur_cat <- brm(
  noundur_z ~ trial * effect_cat + 
    (1 | noun) + (1 | speaker), 
  data = MSA_duration_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "haematopus_fossor_2_noundur_cat")
)

# Frame duration
haematopus_fossor_3_framedur_cat <- brm(
  framedur_z ~ trial * effect_cat + 
    (1 | speaker), 
  data = MSA_duration_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "haematopus_fossor_3_framedur_cat")
)

#
# JVC: same for Vowel
#
vowel <- read_csv(here("data", "analyses", "jvc", "haematopus_fossor", 
  "details", "analysis", "vowelMeasurements.csv"), na = "--undefined--") %>% 
  # Get rid of data with no word or vowel label
  filter(word != "", vowel != "")

# Merge in trial data
vowel$speaker = gsub("\\.", "", vowel$participant)
vowel_full = merge(vowel, trial_data)

# Fix typos in word names
vowel_full$word = gsub("banana","banane", vowel_full$word)
vowel_full$word = gsub("braunen0","braunen", vowel_full$word)
vowel_full$word = gsub("erbeere","erdbeere", vowel_full$word)
vowel_full$word = gsub("greunen","gruenen", vowel_full$word)
vowel_full$word = gsub("gruenen ","gruenen", vowel_full$word)
vowel_full$word = gsub("orangen ","orangen", vowel_full$word)
vowel_full$word = gsub("orangenen","orangen", vowel_full$word)
vowel_full$word = gsub("Paprika","paprika", vowel_full$word)
vowel_full$word = gsub("traubenn","trauben", vowel_full$word)

# Fix typos in vowel label and exclude erroneously segmented segments
vowel_full = vowel_full %>% filter(!vowel %in% c(" ", "@0", "&0", "a0", "e0", "r"))
vowel_full$vowel = gsub("gelben","E1", vowel_full$vowel)
vowel_full$vowel = gsub("E1o","E1", vowel_full$vowel)
vowel_full$vowel = gsub("01","o1", vowel_full$vowel)
vowel_full$vowel = gsub("I.*","I1", vowel_full$vowel)
vowel_full$vowel = gsub("y.*","y1", vowel_full$vowel)

# Define nouns and adjectives
list_of_nouns = c("aprikose", "banane", "bohnen", "erbsen", "erdberre", "gurken", "kartoffeln", "kirche", "mandarine", "moehre", "paprika", "tomate", "trauben", "walnuss", "zitrone")
vowel_full$pos = ifelse(vowel_full$word %in% list_of_nouns, "noun", "adj")

# Define centralisation metric
vowel_full = vowel_full %>% 
  group_by(speaker) %>% 
  mutate(centralisation = sqrt((F1 - mean(F1, na.rm=TRUE))^2 + (F2 - mean(F2, na.rm=TRUE))^2))


#############
# Analyses
#############

adj_full = vowel_full %>% filter(pos == "adj")
noun_full = vowel_full %>% filter(pos == "noun")

# Centre the variables
noun_full$duration.c = scale(noun_full$duration, scale=FALSE)
noun_full$intensity.c = scale(noun_full$intensity, scale=FALSE)
noun_full$centralisation.c = scale(noun_full$centralisation, scale=FALSE)
adj_full$duration.c = scale(adj_full$duration, scale=FALSE)
adj_full$intensity.c = scale(adj_full$intensity, scale=FALSE)
adj_full$centralisation.c = scale(adj_full$centralisation, scale=FALSE)

# Duration analysis
adj_vowel_duration_model = lmer(duration.c ~ trial * typicality + (1 | word) + (1 | speaker), adj_full)
noun_vowel_duration_model = lmer(duration.c ~ trial * typicality + (1 | word) + (1 | speaker), noun_full)

# Intensity analysis
adj_vowel_int_model = lmer(intensity.c ~ trial * typicality + (1 | word) + (1 | speaker), adj_full)
noun_vowel_int_model = lmer(intensity.c ~ trial * typicality + (1 | word) + (1 | speaker), noun_full)

# Centralisation analysis
adj_vowel_cent_model = lmer(centralisation.c ~ trial * typicality + (1 | word) + (1 | speaker), adj_full)
noun_vowel_cent_model = lmer(centralisation.c ~ trial * typicality + (1 | word) + (1 | speaker), noun_full)

#
# JVC: standardize predictors
#
MSA_vowel_noun_df <- noun_full %>% 
  mutate(across(c("duration", "intensity", "centralisation"), .fns = scale, 
    .names = "{.col}_z")) %>% 
  mutate(effect_cat = C(typicality, treatment))

MSA_vowel_adj_df <- adj_full %>% 
  mutate(across(c("duration", "intensity", "centralisation"), .fns = scale, 
    .names = "{.col}_z")) %>% 
  mutate(effect_cat = C(typicality, treatment))


#
# JVC: refit models
#

# Duration analysis
haematopus_fossor_4_adjvoweldur_cat <- brm(
  duration_z ~ trial * effect_cat + 
    (1 | word) + (1 | speaker), 
  data = MSA_vowel_adj_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "haematopus_fossor_4_adjvoweldur_cat")
)

haematopus_fossor_5_nounvoweldur_cat <- brm(
  duration_z ~ trial * effect_cat + 
    (1 | word) + (1 | speaker), 
  data = MSA_vowel_noun_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "haematopus_fossor_5_nounvoweldur_cat")
)

# Intensity analysis
haematopus_fossor_6_adjvowelint_cat <- brm(
  intensity_z ~ trial * effect_cat + 
    (1 | word) + (1 | speaker), 
  data = MSA_vowel_adj_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "haematopus_fossor_6_adjvowelint_cat")
)

haematopus_fossor_7_nounvowelint_cat <- brm(
  intensity_z ~ trial * effect_cat + 
    (1 | word) + (1 | speaker), 
  data = MSA_vowel_noun_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "haematopus_fossor_7_nounvowelint_cat")
)

# Centralisation analysis
haematopus_fossor_8_adjvowelcent_cat <- brm(
  centralisation_z ~ trial * effect_cat + 
    (1 | word) + (1 | speaker), 
  data = MSA_vowel_adj_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "haematopus_fossor_8_adjvowelcent_cat")
)

haematopus_fossor_9_nounvowelcent_cat <- brm(
  centralisation_z ~ trial * effect_cat + 
    (1 | word) + (1 | speaker), 
  data = MSA_vowel_noun_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "haematopus_fossor_9_nounvowelcent_cat")
)
```

## lasionycteris_altavela

```{r}
#| label: print_lasionycteris_altavela
#| echo: false
#| results: 'asis'
print_status("lasionycteris_altavela")
```

```{r}
#| label: lasionycteris_altavela
# Relevant code is in 'analysis.Rmd'
# Starting at line 327

intensity_final <- read_csv(
  here("data", "analyses", "jvc", "lasionycteris_altavela", 
    "intensity_df.csv")) # load this is in

# just look at noun focus trials
intensity_DF <- subset(intensity_final, label == "NF")

#
# JVC: ORIGINAL MODEL (singular fit)
#
intensity_model_lmer <- lmer(
  Intensity ~ typ_mean + 
    (1|target_name) + 
    (1|filename) + 
    (1|filename:target_name), 
  data = intensity_DF
  )

#
# JVC: Standardized model
# - Model contains two variables to standardize: Intensity and typ_mean 
# - Both variables are continuous, parameter estimate for typ_mean will be 
#   effect size (named effect_con)
#
MSA_lasionycteris_altavela_intensity_DF <- intensity_DF %>% 
  mutate(int_z = (Intensity - mean(Intensity)) / sd(Intensity), 
    effect_con = (typ_mean - mean(typ_mean)) / sd(typ_mean))

lasionycteris_altavela_1_int_con <- brm(
  int_z ~ effect_con + 
    (1|target_name) + (1|filename) + (1|filename:target_name), 
  data = MSA_lasionycteris_altavela_intensity_DF, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  file = here("data", "analyses", "models", "lasionycteris_altavela_1_int_con")
  )
```

## linckia_nattereri

```{r}
#| label: print_linckia_nattereri
#| echo: false
#| results: 'asis'
print_status("linckia_nattereri")
```

```{r}
#| label: linckia_nattereri

linckia_nattereri_dat <- read.csv(here("data", "analyses", "jvc", 
"linckia_nattereri", "ResultsNF2.csv")) %>% 
  mutate(typicality = as.factor(typicality))

# Fit original bayesian models with default priors


```

NOTE: Fit bayesian logistic regression model (typicality = DV) with 10 continuous predictors. ASK stef and timo for suggestions. 


## lycodes_bradfieldi

```{r}
#| label: print_lycodes_bradfieldi
#| echo: false
#| results: 'asis'
print_status("lycodes_bradfieldi")
```

```{r}
#| label: lycodes_bradfieldi

# JVC: load data

msa_lycodes_bradfieldi <- read_csv(here("data", "analyses", "jvc", 
  "lycodes_bradfieldi", "processed-data", "all_trial_data_nas_removed.csv")) %>% 
  mutate(typicality = as.factor(typicality), 
    effect_cat = C(typicality, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical")
)

```

Processed data does not include DVs.

## naso_cassivellaunos

```{r}
#| label: print_naso_cassivellaunos
#| echo: false
#| results: 'asis'
print_status("naso_cassivellaunos")
```

```{r}
#| label: naso_cassivellaunos

msa <- read_csv(here("data", "analyses", "jvc", "naso_cassivellaunos", 
  "ProPer_MSA", "data_tables", "ProPer_MSA_scores.csv"))
msa <- msa[msa$syllable %in% c("A_P*", "A_F", "N_P*", "N_F"),]
msa$syllable <- factor(msa$syllable, levels = c("A_P*", "A_F", "N_P*", "N_F"), labels = c("A_Penult", "A_Final", "N_Penult", "N_Final"), ordered = FALSE)
# Set "typical" the 1st / reference level
msa$typicality <- factor(msa$typicality, levels = c("typical", "medium", "atypical"))
# Set "atypical" the 1st / reference level
#msa$typicality <- factor(msa$typicality, levels = c("atypical", "medium", "typical"))

# Reorder target_name wrt typicality
msa$target_name <- factor(msa$target_name)
msa$target_name <- fct_reorder(msa$target_name, as.numeric(msa$typicality))

load(here("data", "analyses", "jvc", "naso_cassivellaunos", 
  "Bayesian analysis", "Mass_Models.rda"))

#
# JVC refit
#

MSA_naso_cassivellaunos_data <- msa %>% 
  mutate(mass_rel_log = log(mass_rel), 
    mass_rel_z = (mass_rel_log - mean(mass_rel_log)) / sd(mass_rel_log), 
    DeltaF0_rel_z = (DeltaF0_rel - mean(DeltaF0_rel)) / sd(DeltaF0_rel), 
    sync_rel_z = (sync_rel - mean(sync_rel)) / sd(sync_rel), 
    effect_cat = C(typicality, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"), 
    syllable = C(syllable, sum))

naso_cassivellaunos_1_mass_cat <- brm(
  mass_rel_z ~ effect_cat * syllable +  
    (1 + effect_cat * syllable | speaker), 
  data = MSA_naso_cassivellaunos_data, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "naso_cassivellaunos_1_mass_cat")
  )

naso_cassivellaunos_2_f0delta_cat <- brm(
  DeltaF0_rel_z ~ effect_cat * syllable +  
    (1 + effect_cat * syllable | speaker), 
  data = MSA_naso_cassivellaunos_data, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "naso_cassivellaunos_2_f0delta_cat")
  )

naso_cassivellaunos_3_syncrel_cat <- brm(
  sync_rel_z ~ effect_cat * syllable +  
    (1 + effect_cat * syllable | speaker), 
  data = MSA_naso_cassivellaunos_data, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "naso_cassivellaunos_3_syncrel_cat")
  )

```

## trapezia_cantonensis

```{r}
#| label: print_trapezia_cantonensis
#| echo: false
#| results: 'asis'
print_status("trapezia_cantonensis")
```

```{r}
#| label: trapezia_cantonensis

if(F) {
msa_raw <- tibble(
  path = Sys.glob(
    glue::glue("{here('./data/analyses/jvc/trapezia_cantonensis/')}/audio_chunks/*/_FastTrack/csvs/*.csv")), 
  file = map(path, read_csv, progress = FALSE, show_col_types = FALSE)) %>%
    unnest(file)

typicality <- tribble(
    ~"adj", ~"noun", ~"typicality",
    "gelben",  "Kirsche", "atypical",
    "gruenen", "Moehre",  "atypical",
    "roten",   "Gurke",   "atypical",
    "orangen", "Trauben", "atypical",
    "braunen", "Paprika", "atypical",
    "gelben",  "Erbsen",     "medium",
    "gruenen", "Tomate",     "medium", 
    "roten",   "Aprikose",   "medium",
    "orangen", "Kartoffeln", "medium",
    "braunen", "Banane",     "medium",
    "gelben",  "Zitrone",   "typical",
    "gruenen", "Bohnen",    "typical",
    "roten",   "Erdbeere",  "typical",
    "orangen", "Mandarine", "typical",
    "braunen", "Walnuss",   "typical",
    "gelben", "Sonnenbrille",   "non-food",
    "gelben", "Socken",         "non-food",
    "gelben", "Waescheklammer", "non-food",
    "gruenen", "Sonnenbrille",   "non-food",
    "gruenen", "Socken",         "non-food",
    "gruenen", "Bueroklammer",   "non-food",
    "roten", "Socken",         "non-food",
    "roten", "Bueroklammer",   "non-food",
    "roten", "Waescheklammer", "non-food",
    "orangen", "Socken",         "non-food",
    "orangen", "Bueroklammer",   "non-food",
    "orangen", "Waescheklammer", "non-food",
    "braunen", "Sonnenbrille",   "non-food",
    "braunen", "Bueroklammer",   "non-food",
    "braunen", "Waescheklammer", "non-food"
)

beast_path <- "/Users/casillas/academia/research/in_progress/many_speech_analyses/many_analyses/./data/analyses/jvc/trapezia_cantonensis//audio_chunks/"

msa_processed <- msa_raw %>% 
  mutate(path = str_remove_all(path, beast_path), 
    path = str_remove_all(path, "/.*/_FastTrack/csvs/"),
    path = str_remove_all(path, "_\\d+\\.csv")) %>% 
    separate(path, into = c("art", "adj", "noun", "speaker_trial"), 
      sep = "_", extra = "merge") %>%
    mutate(noun = str_remove_all(noun, "/")) %>% 
    separate(speaker_trial, into = c("speaker", "trial"), 
      sep = "_(?=\\d+\\Z)") %>%
    # Add the typicality ratings
    left_join(typicality, by = c("adj", "noun")) %>%
    # Get normalized time, and duration
    group_by(speaker, trial) %>%
    mutate(percent = time / max(time),
           dur = max(time) - min(time),
           .after = time) %>%
    ungroup()

msa_for_dur <- msa_processed %>%
  dplyr::select(art, adj, noun, speaker, trial, dur, typicality) %>%
  distinct() %>%
  mutate(typicality = factor(typicality, 
    levels = c("typical", "medium", "atypical", "non-food")))

write_csv(msa_for_dur, 
  file = here("data", "analyses", "jvc", "trapezia_cantonensis", "jvc_tidy.csv"))

dur_lmer <- lmer(
  dur ~ typicality + 
    (1|adj) + (1|speaker), 
  data = msa_for_dur
  )

}

#
# JVC refit
#

MSA_trapezia_cantonensis_data <- read_csv(
  here("data", "analyses", "jvc", "trapezia_cantonensis", "jvc_tidy.csv")
  ) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(dur_z = (dur - mean(dur)) / sd(dur), 
    effect_cat = C(typicality, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"))

trapezia_cantonensis_4_dur_cat <- brm(
  dur_z ~ effect_cat +  
    (1|adj) + (1|speaker), 
  data = MSA_trapezia_cantonensis_data, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "trapezia_cantonensis_4_dur_cat")
  )

```

## trigonias_lachneri

```{r}
#| label: print_trigonias_lachneri
#| echo: false
#| results: 'asis'
print_status("trigonias_lachneri")
```

```{r}
#| label: trigonias_lachneri

msa <- read.csv(here("data", "analyses", "jvc", "trigonias_lachneri", 
  "CSV", "whole_no_errors.csv"))

msa_linear <- subset(msa, select = c(participant, spi, speaker, trial, condition, typicality, target_colour,typ_mean))
#correcting variable types in R
msa_linear$participant <- as.factor(msa_linear$participant)
msa_linear$speaker <- as.factor(msa_linear$speaker)
msa_linear$trial <- as.integer(msa_linear$trial)
msa_linear$spi <- as.numeric(msa_linear$spi)
msa_linear$condition <- as.factor(msa_linear$condition)
msa_linear$typicality <- as.factor(msa_linear$typicality)
msa_linear$target_colour <- as.factor(msa_linear$target_colour)

spi_base <- msa_linear %>%
  filter(condition %in% "NF")
spi_base$spi <- log(spi_base$spi)

spi.var.md <- lmer(spi ~ typ_mean + 
    (1 + typ_mean|target_colour) + 
    (1 + typ_mean|speaker), 
  data = spi_base, 
  control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000)), 
  REML = TRUE)

#
# JVC refit
#

MSA_trigonias_lachneri_spi_data <- spi_base %>% 
  mutate(spi_z = (spi - mean(spi, na.rm = T)) / sd(spi, na.rm = T)) %>% 
  mutate(effect_con = (typ_mean - mean(typ_mean)) / sd(typ_mean))

trigonias_lachneri_1_spi_con <- brm(
  spi_z ~ effect_con + 
    (1 + typ_mean|target_colour) + 
    (1 + typ_mean|speaker),
  data = MSA_trigonias_lachneri_spi_data, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", 
  control = list(adapt_delta = 0.99), 
  file = here("data", "analyses", "models", "trigonias_lachneri_1_spi_con")
  )

```


## psittacula_scabriculus

```{r}
#| label: print_psittacula_scabriculus
#| echo: false
#| results: 'asis'
print_status("psittacula_scabriculus")
```

```{r}
#| label: psittacula_scabriculus

MSA_psittacula_scabriculus_raw <- read_xlsx(
  path = here("data", "analyses", "jvc", "psittacula_scabriculus", 
    "Data_and_analysis", "psittacula_scabriculus_full_dataset_checked.xlsx"))


MSA <- MSA_psittacula_scabriculus_raw %>%
  arrange(target_name) %>% #orders the rows of the data by the target_name column
  group_by(target_name) %>% #group by the target name
  transform(items = as.numeric(factor(target_name)))%>% #transform target name into a item
  select(items, target_name, everything()
         ) #select all variables from items and target_name 

MSAcomplete <- MSA %>% 
  filter (condition == 'NF') %>% 
  filter (avgdur > 0) 

#count notpronounced for each vowel (1,2,3,4)
M_not <- MSAcomplete %>%
  filter(dur1 == "notpronounced"|dur2 == "notpronounced"|dur3 == "notpronounced"|dur4 == "notpronounced")

dur1_not <- M_not%>%
  filter(dur1 == "notpronounced")
dur2_not <- M_not%>%
  filter(dur2 == "notpronounced")
dur3_not <- M_not%>%
  filter(dur3 == "notpronounced")
dur4_not <- M_not%>%
  filter(dur4 == "notpronounced")

#Convert the average duration from character to number. 
MSAcomplete$avgdur <- as.numeric(MSAcomplete$avgdur)

regularizing_priors <- prior('normal(0, 1)', class = 'b')
options(mc.cores=parallel::detectCores())
# Original model
set.seed(42)

if(F) {
MSA_mdl <- brm(
  avgdur ~ 1 + typicality + 
    (1 + typicality |participant) +  
    (1 + typicality |items), 
  data = MSAcomplete, 
  prior = regularizing_priors,  
  seed = 42, init = 0, cores = 4, 
  chains = 4, warmup = 2000, iter = 4000)
}


#
# JVC refit
#

msa_psittacula_scabriculus_df <- MSAcomplete %>% 
  mutate(avgdur_z = (avgdur - mean(avgdur)) / sd(avgdur), 
    effect_cat = as.factor(typicality), 
    effect_cat = C(effect_cat, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"))

psittacula_scabriculus_1_dur_cat <- brm(
  avgdur_z ~ effect_cat +  
    (1 + effect_cat | participant) +  
    (1 + effect_cat | items), 
  data = msa_psittacula_scabriculus_df, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "psittacula_scabriculus_1_dur_cat")
  )

```


## clione_dorsalis

```{r}
#| label: print_clione_dorsalis
#| echo: false
#| results: 'asis'
print_status("clione_dorsalis")
```

```{r}
#| label: clione_dorsalis

#read and clean the data
data_formants_duration <- read.csv(
  here("data", "analyses", "jvc", "clione_dorsalis", 
  "MSA_formantlog.csv"))
data_vs <- read.csv(
    here("data", "analyses", "jvc", "clione_dorsalis", 
    "MSA_formantlog_vowel space area.csv"))

data_no_NA <- subset(data_formants_duration, typicality != "NA")
data_formant_midpoint <- subset(data_no_NA, timept == "3")
data_vs <- plyr::rename(data_vs, c("atypical"="vowel_space_area"))
data_2 <- subset(data_vs, timepoint == "2")
data_4 <- subset(data_vs, timepoint == "4")
formants_tp_2 <- subset(data_no_NA, timept == "2")
formants_tp_4 <- subset(data_no_NA, timept == "4")

# REfit original models
duration.mod <- lmer(word.duration ~ typicality + vowel + gender + (1|filename), data=data_formant_midpoint)

vsa.mod.2 <- lmer(vowel_space_area ~ typicality + (1|subject),data=data_2)
vsa.mod.4 <- lmer(vowel_space_area ~ typicality + (1|subject),data=data_4)

###F1 and F2 models
mod.4 <- lmer(f1 ~ typicality*vowel + gender + (1|filename), data=formants_tp_2)
mod.5 <- lmer(f2 ~ typicality*vowel + gender + (1|filename), data=formants_tp_2)
mod.6 <- lmer(f1 ~ typicality*vowel + gender + (1|filename), data=formants_tp_4)
mod.7 <- lmer(f2 ~ typicality*vowel + gender + (1|filename), data=formants_tp_4)


#
# JVC refit
#
msa_clione_dorsalis_mp <- data_formant_midpoint %>% 
  mutate(
    word_duration_z = (word.duration - mean(word.duration)) / sd(word.duration), 
    effect_cat = as.factor(typicality), 
    effect_cat = C(effect_cat, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"), 
    vowel = as.factor(vowel), 
    vowel = C(vowel, sum), 
    gender = as.factor(gender), 
    gender = C(gender, sum)
    )

clione_dorsalis_1_mp_cat <- brm(
  word_duration_z ~ effect_cat + vowel + gender + 
    (1|filename), 
  data = msa_clione_dorsalis_mp, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "clione_dorsalis_1_mp_cat")
  )

msa_clione_dorsalis_vs <- data_2 %>% 
  mutate(
    vowel_space_area_z = (vowel_space_area - mean(vowel_space_area)) / sd(vowel_space_area), 
    effect_cat = as.factor(typicality), 
    effect_cat = C(effect_cat, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"), 
  )

clione_dorsalis_2_vs_cat <- brm(
  vowel_space_area_z ~ effect_cat + 
    (1 | subject), 
  data = msa_clione_dorsalis_vs, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "clione_dorsalis_2_vs_cat")
  )

msa_clione_dorsalis_vs4 <- data_4 %>% 
  mutate(
    vowel_space_area_z = (vowel_space_area - mean(vowel_space_area)) / sd(vowel_space_area), 
    effect_cat = as.factor(typicality), 
    effect_cat = C(effect_cat, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"), 
  )

clione_dorsalis_3_vs4_cat <- brm(
  vowel_space_area_z ~ effect_cat + 
    (1 | subject), 
  data = msa_clione_dorsalis_vs4, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "clione_dorsalis_3_vs4_cat")
  )

msa_clione_dorsalis_f1f22 <- formants_tp_2 %>% 
  mutate(
    f1_z = (f1 - mean(f1)) / sd(f1), 
    f2_z = (f2 - mean(f2)) / sd(f2), 
    effect_cat = as.factor(typicality), 
    effect_cat = C(effect_cat, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"), 
    vowel = as.factor(vowel), 
    vowel = C(vowel, sum), 
    gender = as.factor(gender), 
    gender = C(gender, sum)
  )

clione_dorsalis_4_f12_cat <- brm(
  f1_z ~ effect_cat + vowel + gender + 
    (1|filename), 
  data = msa_clione_dorsalis_f1f22, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "clione_dorsalis_4_f12_cat")
  )

clione_dorsalis_5_f22_cat <- brm(
  f2_z ~ effect_cat + vowel + gender + 
    (1|filename), 
  data = msa_clione_dorsalis_f1f22, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "clione_dorsalis_5_f22_cat")
  )

msa_clione_dorsalis_f1f24 <- formants_tp_4 %>% 
  mutate(
    f1_z = (f1 - mean(f1)) / sd(f1), 
    f2_z = (f2 - mean(f2)) / sd(f2), 
    effect_cat = as.factor(typicality), 
    effect_cat = C(effect_cat, treatment), 
    effect_cat = fct_relevel(effect_cat, "atypical"), 
    vowel = as.factor(vowel), 
    vowel = C(vowel, sum), 
    gender = as.factor(gender), 
    gender = C(gender, sum)
  )

clione_dorsalis_6_f14_cat <- brm(
  f1_z ~ effect_cat + vowel + gender + 
    (1|filename), 
  data = msa_clione_dorsalis_f1f24, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "clione_dorsalis_6_f14_cat")
  )

clione_dorsalis_7_f24_cat <- brm(
  f2_z ~ effect_cat + vowel + gender + 
    (1|filename), 
  data = msa_clione_dorsalis_f1f24, 
  cores = 4, threads = threading(2, grainsize = 100), 
  backend = "cmdstanr", seed = 06022016, 
  file = here("data", "analyses", "models", "clione_dorsalis_7_f24_cat")
  )

```




# Results

## Load models

```{r}
#| label: load-models

msa_models <- dir_ls(path = here("data", "analyses", "models"), 
  regexp = ".rds$") %>% 
  as_tibble() %>% 
  transmute(path = value, 
    mod_name = str_remove(path, here("data", "analyses", "models/")), 
    mod_name = str_remove(mod_name, ".rds"), 
    model = map(path, ~ readRDS(file = .))) %>% 
  separate(mod_name, 
    into = c("word1", "word2", "mod_n", "outcome", "typicality"), 
    sep = "_", remove = F) %>% 
  unite(group, word1, word2, sep = "_") %>% 
  dplyr::select(group, mod_name:model) %>% 
  mutate(sum = map(model, clean_up)) %>% 
  suppressWarnings() 
```

## Table

```{r}
#| label: effect-table

# Simple pandoc table of the models, estimates, se, etc.
msa_models %>% 
  unnest(sum) %>% 
  dplyr::select(-model) %>% 
  knitr::kable(format = "pandoc")

```

## Plot

```{r}
#| label: forest-plot
#| fig.height: 8

# Simple forest plot of the estimates +/- SE
msa_models %>% 
  unnest(sum) %>% 
  mutate(typicality_lab = if_else(typicality == "cat", 
    "Typicality = categorical", "Typicality = continuous"), 
    mod_name = fct_reorder(mod_name, estimate)) %>% 
  ggplot() + 
  facet_wrap(~ typicality_lab, ncol = 1, scales = "free") + 
  aes(x = estimate, y = mod_name) + 
  geom_vline(xintercept = 0, lty = 3) + 
  geom_segment(aes(x = estimate - se, xend = estimate + se, yend = mod_name), 
    color = "#cc0033", alpha = 0.5, size = 1.5, lineend = "round") + 
  geom_point(color = "#cc0033", pch = 21, stroke = 1.5, size = 1.6) + 
  labs(y = "Model", x = "Estimate ± SE") + 
  clean_theme() + 
  theme(strip.text.x = element_text(hjust = 0))
```

