---
title: "Get CRediT"
author: "Joseph V. Casillas"
output: html_document
date: "Last upate: `r Sys.Date()`"
---

## Load libraries

```{r setup}
#| label: setup
#| include: false
knitr::opts_chunk$set(
  echo = TRUE, 
  message = FALSE, 
  warning = FALSE
  )

knitr::opts_knit$set(root.dir = here::here())
```

```{r}
#| label: load-libs
library("googlesheets4")
library("googledrive")
library("xml2")
library("dplyr")
library("tidyr")
library("stringr")
library("ggplot2")
library("forcats")
library("readr")
library("kableExtra")
```

## Get google sheet and tidy

```{r}
#| label: identify-download
#| eval: false

# give gargle permission
drive_auth(email = TRUE)

# Locate file, check ID
drive_find(n_max = 5, type = "spreadsheet")

# Old sheet
#all_data_temp <- read_sheet("1lXmubF42sTCoOaECXGzo20GCFxX51MWFOKhX8euNtuA") %>% 
#  janitor::clean_names()

# New sheet
all_data_temp <- read_sheet("1lXmubF42sTCoOaECXGzo20GCFxX51MWFOKhX8euNtuA") %>% 
  janitor::clean_names()

# Download to doc folder
write_csv(all_data_temp, "data/CRediT/MSA_tenzing_contribution.csv")
```



```{r}
#| label: load-tidy-csv
# Load data
#all_data_temp <- read_csv("data/CRediT/MSA_tenzing_contribution.csv")
all_data_temp <- 
  read_csv("data/CRediT/MSA_tenzing_contribution-corrected_contributions.csv") %>% 
  janitor::clean_names()

# Create vector of surnames of initiating authors
initiating_authors <- c("Coretta", "Casillas", "Roessig", "Franke", "Roettger")

# Subset initiating authors
initiators <- all_data_temp %>% 
  filter(surname %in% initiating_authors) %>% 
  mutate(is_initiating = 1)

# Subset analysts
analysts <- all_data_temp %>% 
  filter(!(surname %in% initiating_authors)) %>% 
  mutate(is_initiating = 0) %>% 
  arrange(surname)

# Combine dfs in correct order
contributors <- bind_rows(initiators, analysts) %>% 
  mutate(middle_name = replace_na(middle_name, ""),
    is_initiating = if_else(surname %in% initiating_authors, 1, 0), 
    initials = glue::glue("{str_sub(firstname, 1, 1)}{str_sub(middle_name, 1, 1)}{str_sub(surname, 1, 1)}")) %>% 
  unite(name, c("firstname", "middle_name", "surname"), sep = " ") %>% 
  mutate(name = str_replace_all(name, "  ", " ")) %>% 
  bind_rows(
    slice(., which(name != "Timo B. Roettger")), 
    slice(., which(name == "Timo B. Roettger"))
    ) %>%
  tail(nrow(.) / 2)

```



## Author list

```{r}
#| label: print-names

author_list <- contributors %>% 
  pull(name) %>% 
  knitr::combine_words(words = .)
```

These are the authors:  
`r author_list`


## Institutions

```{r}
#| label: institutions
#| out.width: 100%
#| fig.height: 8

# Get count of unique affiliations
affiliations <- contributors %>% 
  count(primary_affiliation) %>% 
  arrange(n) 

# Plot affiliations as a function of n
affiliations %>% 
  mutate(lab_truc = str_sub(primary_affiliation, 1, 30),
    lab_truc = fct_reorder(lab_truc, n, min)) %>% 
  ggplot() + 
  aes(x = n, y = lab_truc) + 
  geom_segment(aes(x = 0, xend = n, yend = lab_truc)) + 
  geom_point() + 
  labs(y = NULL) + 
  theme_bw(base_size = 9)
```

There were `r nrow(contributors)` contributors from `r nrow(affiliations)` institutions. 
`r filter(affiliations, is.na(primary_affiliation)) %>% pull(n) %>% xfun::numbers_to_words() %>% str_to_sentence()` analysts did not include their primary affiliation. 

## Contributor roles taxonomy

```{r}
#| label: contributor-roles-plot-initiators
#| out.width: 100%
#| fig.height: 4

# Vector of formated contributor roles
contributor_role <- c(
    "Conceptualization", "Data curation", "Formal Analysis",
    "Funding acquisition", "Investigation", "Methodology",
    "Project administration", "Resources", "Software", "Supervision",
    "Validation", "Visualization", "Writing - original draft",
    "Writing - review & editing"
  )

# Format contributors for plotting
cr_prep <- contributors %>% 
  select(name:writing_review_editing, is_initiating, initials) %>% 
  pivot_longer(
    cols = -c("name", "is_initiating", "initials"), 
    names_to = "contributor_roles", 
    values_to = "val"
    ) %>% 
  mutate(val = as.numeric(val)) %>% 
  group_by(name, contributor_roles) %>% 
  mutate(order_x = seq_along(name)) %>% 
  group_by(name) %>% 
  mutate(order_y = seq_along(name)) %>% 
  ungroup() %>% 
  mutate(contributor_roles = fct_rev(contributor_roles))


# Plot initiating authors
cr_prep %>% 
  filter(is_initiating == 1) %>% 
  mutate(name = fct_relevel(name, "Stefano Coretta", "Joseph V. Casillas", 
                            "Simon Roessig", "Michael Franke"), 
    contributor_roles = str_replace_all(contributor_roles, "_", " "), 
    contributor_roles = str_replace_all(contributor_roles, "ting ", "ting - "), 
    contributor_roles = str_to_title(contributor_roles)
    ) %>% 
  ggplot() +
  aes(x = name, y = contributor_roles, alpha = val) +
    geom_point(size = 3.5, pch = 18, show.legend = F) +
    scale_x_discrete(position = "top") + 
    scale_y_discrete(limits = rev) + 
    scale_alpha_continuous(range = c(0.05, 1)) +
    labs(x = "Initiating authors", y = "Contributor roles",
         caption = "Author contributions based on CRediT taxonomy") +
    theme_minimal(base_size = 12, base_family = "Times") +
    theme(
      axis.title.y = element_text(size = rel(.9), hjust = 0.95),
      axis.title.x = element_text(size = rel(.9), hjust = 0.95),
      panel.grid.major = element_line(colour = 'grey90', size = 0.15),
      panel.grid.minor = element_line(colour = 'grey90', size = 0.15)
    )

ggsave("figs/credit-taxonomy-initiators.png", width = 7, height = 5)

```



```{r}
#| label: contributor-roles-plot-analysts
#| out.width: 100%
#| fig.height: 10

cr_prep %>% 
  filter(is_initiating == 0) %>% 
   mutate(
    contributor_roles = str_replace_all(contributor_roles, "_", " "), 
    contributor_roles = str_replace_all(contributor_roles, "ting ", "ting - "), 
    contributor_roles = str_to_title(contributor_roles)
    ) %>% 
  ggplot() +
  aes(y = name, x = contributor_roles, alpha = val) +
    geom_point(size = 1.75, pch = 18, show.legend = F) +
    scale_alpha_continuous(range = c(0.05, 1)) +
    scale_y_discrete(limits = rev) + 
    labs(x = NULL, y = "Analysts",
         caption = "Contributor roles\nAuthor contributions based on CRediT taxonomy") +
    theme_light(base_size = 12, base_family = "Times") +
    theme(
      axis.title.y = element_text(size = rel(.9), hjust = 0.95),
      axis.title.x = element_text(size = rel(.9), hjust = 0.95),
      panel.grid.major = element_line(colour = 'grey90', size = 0.15),
      panel.grid.minor = element_line(colour = 'grey90', size = 0.15), 
      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, 
                                     size = rel(0.6)), 
      axis.text.y = element_text(size = rel(0.5))
    )

ggsave("figs/credit-taxonomy-analysts.png", width = 14, height = 10)
```





```{r}
#| label: contributor-roles-plot-all
#| out.width: 100%
#| fig.height: 11

cr_prep %>% 
   mutate(
    name = fct_reorder(name, is_initiating), 
    contributor_roles = str_replace_all(contributor_roles, "_", " "), 
    contributor_roles = str_replace_all(contributor_roles, "ting ", "ting - "), 
    contributor_roles = str_to_title(contributor_roles)
    ) %>% 
  ggplot() +
  aes(y = name, x = contributor_roles, alpha = val) +
    geom_point(size = 1.75, pch = 18, show.legend = F) + 
    scale_y_discrete(limits = rev) + 
    scale_alpha_continuous(range = c(0.05, 1)) +
    labs(x = NULL, y = "Contributors",
         caption = "Contributor roles\nAuthor contributions based on CRediT taxonomy") +
    theme_light(base_size = 12, base_family = "Times") +
    theme(
      axis.title.y = element_text(size = rel(.9), hjust = 0.95),
      axis.title.x = element_text(size = rel(.9), hjust = 0.95),
      panel.grid.major = element_line(colour = 'grey90', size = 0.15),
      panel.grid.minor = element_line(colour = 'grey90', size = 0.15), 
      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, 
        size = rel(0.6)), 
      axis.text.y = element_text(size = rel(0.5))
    )

ggsave("figs/credit-taxonomy-all.png", width = 14, height = 10)
```



```{r}
#| label: copy-author-list
#| eval: false
# Copy author list to the clipboard so it can be pasted in RR
contributors %>% 
  select(name) %>% 
  mutate(name = glue::glue("- name: {name}\n")) %>% 
  pull() %>% 
  clipr::write_clip() 
```
